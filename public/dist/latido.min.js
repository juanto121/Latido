/*! latido - v1.0.0 - 2016-08-06
* Copyright (c) 2016 ; Licensed  */
var Hrmonitor=function(){function a(){this.initHrmonitor()}var b=a.prototype;return b.initHrmonitor=function(){this.minBpm=50,this.maxBpm=200,this.fps=60,this.windowDuration=10,this.bufferSize=512,this.buffer=[],this.dataTimes=[],this.dataValues=[]},b.getFps=function(){var a=this.buffer.length,b=this.buffer[a-1].time,c=this.buffer[0].time,d=(b-c)/1e3,e=a/d;return parseInt(e)},b.bufferFull=function(){return this.buffer.length>=this.bufferSize},b.isReady=function(){return this.buffer.length>=2},b.addSample=function(a){this.bufferFull()&&(this.buffer.shift(),this.dataTimes.shift(),this.dataValues.shift()),this.buffer.push(a),this.dataTimes.push(a.time),this.dataValues.push(a.value)},b.getFFT=function(){var a=this.bufferSize,b=this.dataTimes[0],c=this.dataTimes[this.dataTimes.length-1],d=numeric.linspace(b,c,a),e=everpolate.linear(d,this.dataTimes,this.dataValues),f=d.length,g=new FFT(f,this.getFps());return g.forward(e),g.spectrum},b.binToBpm=function(a){return 60*a*this.getFps()/this.bufferSize},b.bpmToBin=function(a){return a*this.bufferSize/(60*this.getFps())},b.getBpm=function(){for(var a=this.getFFT(),b=(a.length,parseInt(this.bpmToBin(this.minBpm))),c=parseInt(this.bpmToBin(this.maxBpm)),d=0,e=0,f=b;c>f;f++)a[f]>d&&(e=f,d=a[f]);return{bpm:this.binToBpm(e),freqs:a}},a}(),Camera=function(){function a(){this.initCamera()}var b=a.prototype;return b.initCamera=function(){this.cameraReady=!1,this.videoElement=document.querySelector("video"),navigator.getMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,navigator.getMedia({video:!0,audio:!1},this.onMediaStream.bind(this),this.errMediaStream.bind(this))},b.onMediaStream=function(a){this.mediaStream=a;var b=this,c=this.videoElement;this.videoElement.src=window.URL.createObjectURL(a),this.videoElement.onloadedmetadata=function(a){b.cameraReady=!0,c.play()}},b.isReady=function(){return this.cameraReady},b.errMediaStream=function(a){console.log("Media stream error")},a}(),FaceDetector=function(){function a(){this.initFaceDetector()}var b=a.prototype;return b.initFaceDetector=function(){},b.getFaces=function(a){var b=this;$(a).faceDetection({complete:b.faceDetected.bind(this)})},b.faceDetected=function(a){void 0!==a[0]&&this.listener(a)},b.setListener=function(a){this.listener=a},a}(),FaceTracker=function(){function a(){this.initFaceTrack()}var b=a.prototype;return b.initFaceTrack=function(){this.fhx=.5,this.fhy=.13,this.fhw=.25,this.fhh=.15},b.update=function(a){this.face=a},b.getForehead=function(){var a=this.face[0],b=a.x,c=a.y,d=a.width,e=a.height;b+=d*this.fhx,c+=e*this.fhy,d*=this.fhw,e*=this.fhh,b-=d/2,c-=e/2;var f={x:b,y:c,w:d,h:e};return f},a}(),ImageProcessor=function(){function a(){this.canvas=document.querySelector("canvas"),this.ctx=this.canvas.getContext("2d")}var b=a.prototype;return b.sampleFrame=function(a,b){var c=b.x,d=b.y,e=b.w,f=b.h,g=0,h=0,i=b.w,j=b.h;this.ctx.drawImage(a,c,d,e,f,g,h,i,j);for(var k=this.ctx.getImageData(0,0,e,f),l=k.data.length,m=1,n=0,o=0,m=1;l>m;m+=4)o+=k.data[m],n++;return o/=n,{time:Date.now(),value:o}},a}(),Graph=function(){function a(){this.init()}var b=a.prototype;return b.init=function(){this.chart=new Rickshaw.Graph({element:document.getElementById("chart"),height:500,renderer:"line",series:new Rickshaw.Series.FixedDuration([{name:"one",color:"green"},{name:"two",color:"red"}],void 0,{timeInterval:250,maxDataPoints:100,timeBase:(new Date).getTime()/1e3})}),this.chart.render()},b.updateRawSample=function(a){var b={one:a};this.chart.series.addData(b)},b.updateBpm=function(a){var b={two:a};this.chart.series.addData(b)},b.render=function(){this.chart.render()},a}(),Main=function(){function a(){this.init()}var b=a.prototype;return b.init=function(){this.current=Date.now(),this.last=Date.now(),this.seconds=document.getElementById("seconds"),this.bpmElement=document.getElementById("bpm"),this.videoElement=document.querySelector("video"),this.camera=new Camera,this.hrmonitor=new Hrmonitor,this.faceDetector=new FaceDetector,this.faceTracker=new FaceTracker,this.imageproc=new ImageProcessor,this.faceDetector.setListener(this.faceDetected.bind(this)),this.chart=new Graph},b.updateUI=function(){this.seconds.textContent=(Date.now()-this.startTime)/1e3,this.hrmonitor.buffer.length>=this.hrmonitor.bufferSize-5&&(console.log(this.bpm.bpm),this.bpmElement.textContent=parseInt(this.bpm.bpm))},b.update=function(){this.last=Date.now();this.last-this.current;this.camera.isReady()&&(this.hrmonitor.isReady()?(this.bpm=this.hrmonitor.getBpm(),this.sampleFrame(),this.updateUI()):(this.faceDetector.getFaces(this.camera.videoElement),this.current=this.last,this.startTime=Date.now())),requestAnimationFrame(this.update.bind(this))},b.faceDetected=function(a){this.faceTracker.update(a),this.sampleFrame()},b.sampleFrame=function(){var a=this.imageproc.sampleFrame(this.videoElement,this.faceTracker.getForehead());return this.hrmonitor.addSample(a),a},a}(),ServiceWorker=function(){function a(){this.init()}var b=a.prototype;return b.init=function(){},a}();window.onload=function(){var a=new Main;a.update();new ServiceWorker};